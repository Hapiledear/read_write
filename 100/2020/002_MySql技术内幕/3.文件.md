# 参数文件
MySQL数据库的参数文件是以文本方式进行存储的。用户可以直接通过一些常用的文本编辑软件（如vi和emacs）进行参数的修改。
可以通过命令`SHOW VARIABLES`查看数据库中的所有参数，也可以通过`LIKE`来过滤参数名.
## 参数类型
MySQL数据库中的参数可以分为两类：动态参数和静态参数。
可以通过SET命令对动态的参数值进行修改，set分为两个范围：global和session。表明该参数的修改是基于当前会话还是整个实例的生命周期。
# 日志文件
日志文件记录了影响MySQL数据库的各种类型活动，常见的日志文件有如下4种：
## 错误日志
定义：错误日志文件对MySQL的启动、运行、关闭过程进行了记录。
作用：MySQL DBA在遇到问题时应该首先查看该文件以便定位问题。
记录的内容:该文件不仅记录了所有的错误信息，也记录一些警告信息或正确的信息。
查看方式：可通过命令`SHOW VARIABLES LIKE'log_error'`来定位该文件位置。

## 慢查询日志
可帮助定位可能存在问题的SQL语句，从而进行SQL语句层面的优化。
通过两个参数分别控制：
- 参数`long_query_time`来设置阈值，默认10秒。如果sql的执行时间超过了这个值(不包含10秒)，就会被记录到日志中。
- 参数`log_queries_not_using_indexes`=On.如果sql语句没有使用索引，也将这条SQL语句记录到慢查询日志文件。
- 从5.6.5版本开始增加了一个参数`log_throttle_queries_not_using_indexes`.用以限制每分钟未使用索引的SQL语句写入日志表的次数。

随着MySQL数据库服务器运行时间的增加，可能会有越来越多的SQL查询被记录到了慢查询日志文件中，此时要分析该文件就显得不是那么简单和直观的了。为此，有如下两种解决办法:
- 使用`mysqldumpslow`命令.
- 从5.1开始，可以将慢查询的日志记录放入一张表中(slow_log).

Inno SQL版本加强了对于SQL语句的捕获方式。在原版MySQL的基础上在slow log中增加了对于逻辑读取（logical reads 所有的读取，不管是磁盘还是缓冲池）和物理读取（physical reads 从磁盘进行IO读取的次数）的统计.

## 查询日志
查询日志记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行.
从MySQL 5.1开始，可以将查询日志的记录放入mysql架构下的general_log表中.

## 二进制日志
二进制日志（binary log）记录了对MySQL数据库执行更改的所有操作，但是不包括SELECT和SHOW这类操作，因为这类操作对数据本身并没有修改。
若操作本身并没有导致数据库发生变化，那么该操作可能也会写入二进制日志。
如果用户想记录SELECT和SHOW操作，那只能使用查询日志。

使用二进制日志，可以有如下三种用途：
- 恢复（recovery）：某些数据的恢复需要二进制日志，例如，在一个数据库全备文件恢复后，用户可以通过二进制日志进行point-in-time的恢复。
- 复制（replication）：其原理与恢复类似，通过复制和执行二进制日志使一台远程的MySQL数据库（一般称为slave或standby）与一台MySQL数据库（一般称为master或primary）进行实时同步。
- 审计（audit）：用户可以通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入的攻击。

二进制日志文件在默认情况下并没有启动，需要手动指定参数来启动。有如下相7个相关参数：
- max_binlog_size。指定单个二进制日志文件的最大值，如果超过该值，则产生新的二进制日志文件，后缀名+1，并记录到.index文件。默认大小为1G
- binlog_cache_size。基于会话（session）的 控制事务的缓存区大小，默认32K.所有未提交（uncommitted）的二进制日志会被记录到该缓存中去，等该事务提交（committed）时直接将缓冲中的二进制日志写入二进制日志文。
- sync_binlog。控制每写缓冲N次就同步到磁盘。默认为0。当N=1时，写操作不使用操作系统的缓冲来写二进制日志。
- binlog-do-db。需要写入哪些库的日志。默认为空，表示需要同步所有库的日志到二进制日志。
- binlog-ignore-db。需要忽略写入哪些库的日志。默认为空，表示需要同步所有库的日志到二进制日志。
- log-slave-update。=False时，如果当前数据库是复制中的slave角色，则它不会将从master取得并执行的二进制日志写入自己的二进制日志文件中去。如果需要搭建master=＞slave=＞slave架构的复制，则必须设置该参数。
- **binlog_format**.控制记录二进制日志的格式。主要有三种：
    - STATEMENT格式。记录的是日志的逻辑SQL语句。
    - ROW格式。记录表的行更改情况。
    - MIXED格式。默认采用STATEMENT格式进行二进制日志文件的记录，但是在下列情况下会使用ROW格式：
        - 表的存储引擎为NDB，这时对表的DML操作都会以ROW格式记录。
        - 使用了UUID()、USER()、CURRENT_USER()、FOUND_ROWS()、ROW_COUNT()等不确定函数。
        - 使用了INSERT DELAY语句。
        - 使用了用户定义函数（UDF）
        - 使用了临时表（temporary table）。

通常情况下，我们会设置为ROW格式。这可以为数据库的恢复和复制带来更好的可靠性，但会带来二进制文件大小的增加。

二进制日志文件的文件格式为二进制，不能像错误日志文件、慢查询日志文件那样用cat、head、tail等命令来查看，必须通过MySQL提供的工具mysqlbinlog。

## 套接字文件
在UNIX系统下本地连接MySQL可以采用UNIX域套接字方式[^1]，这种方式需要一个套接字（socket）文件。该文件的作用是辅助客户端(service)进行域套接字连接，类型是s,表示的是socket文件。

## pid文件
当MySQL实例启动时，会将自己的进程ID写入该文件中。

## 表结构定义文件
这是一个以frm为后缀名的文件，记录了该表的表结构定义，frm还用来存放视图的定义。该文件是文本文件，可以直接使用cat命令进行查看。

# InnoDB存储引擎文件
## 表空间文件
InnoDB采用将存储的数据按表空间（tablespace）进行存放的设计。在默认配置下会有一个初始大小为10MB，名为ibdata1的文件。可通过`innodb_data_file_path`进行设置。
`innodb_data_file_path=/db/ibdata1:2000M;/dr2/db/ibdata2:2000M:autoextend`
可以用两个文件用来组成表空间，若这两个文件位于不同的磁盘上，磁盘的负载可能被平均，这么做可以提高数据库的整体性能。
同时，这两个文件的文件名后都跟了属性，表示文件的大小。如果用完了，可以自动增长。
还有一个参数`innodb_file_per_table=ON`可将用户的每个基于InnoDB存储引擎的表产生一个独立表空间，命名规则为：表名.ibd。这样，用户不用将所有数据都存放于默认的表空间中。
这些单独的表空间文件仅存储该表的数据、索引和插入缓冲bitmap等信息，其余信息还是存放在默认的表空间中。

## 重做日志文件
在默认情况下，在InnoDB存储引擎的数据目录下会有两个名为ib_logfile0和ib_logfile1的文件，便是重做日志文件(redo log file).
数据库由于所在主机掉电导致实例失败时，InnoDB存储引擎会使用重做日志恢复到掉电前的时刻，以此来保证数据的完整性。
每个InnoDB存储引擎至少有1个重做日志文件组（group），每个文件组下至少有2个重做日志文件，用户可以设置多个的镜像日志组（mirrored log groups），将不同的文件组放在不同的磁盘上，以此提高重做日志的可用性。
在日志组中每个重做日志文件的大小一致，并以循环写入的方式运行。
下列4个参数影响着重做日志文件的属性：
- innodb_log_file_size。指定每个重做日志文件的大小，最大为512G。
- innodb_log_files_in_group.指定了日志文件组中重做日志文件的数量，默认为2。
- innodb_mirrored_log_groups。指定了日志镜像文件组的数量，默认为1。若磁盘本身已经做了高可用的方案，如磁盘阵列，那么可以不开启重做日志镜像的功能。
- innodb_log_group_home_dir。指定了日志文件组所在路径，默认为./，表示在MySQL数据库的数据目录下。

重做日志文件的大小对于性能的影响主要有三方面：
- 重做日志文件不能设置得太大，如果设置得很大，在恢复时可能需要很长的时间
- 不能设置得太小了，否则可能导致一个事务的日志需要多次切换重做日志文件
- 太小还会导致频繁地发生async checkpoint，导致性能的抖动

与MySql的二进制日志文件的区别：
不同点 | 二进制日志文件|重做日志文件
------------ | -------------| -------------
记录的内容 | 记录所有与MySQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等其他存储引擎的日志|只记录有关该存储引擎本身的事务日志
记录的方式 | 记录的都是关于一个事务的具体操作内容，即该日志是逻辑日志|记录的是关于每个页（Page）的更改的物理情况
写入的时间|仅在事务提交前进行提交，只写磁盘一次，不论这时该事务多大|在事务进行的过程中，却不断有重做日志条目（redo entry）被写入到重做日志文件中。

重做日志条目由4个部分组成：
- redo_log_type占用1字节，表示重做日志的类型
- space表示表空间的ID，但采用压缩的方式，因此占用的空间可能小于4字节
- page_no表示页的偏移量，同样采用压缩的方式
- redo_log_body表示每个重做日志的数据部分，恢复时需要调用相应的函数进行解析

写入重做日志文件的流程如下：
```flow
start=>start
end=>end
op_1=>operation: 写入重做日志缓冲（redo log buffer）中
cond_1=>condition: 满足一定条件时
op_2=>operation: 按一个扇区的大小(512字节)顺序的写入磁盘中的日志文件

start->op_1->cond_1
cond_1(yes)->op_2->end
```
该过程无需双写，因为扇区是写入的最小单位，可以保证写入必定是成功的。
流程中的一定条件主要有两条：
- 主线程中每秒会将重做日志缓冲写入磁盘的重做日志文件中，不论事务是否已经提交。
- 在提交（commit）操作时，处理重做日志。由参数`nnodb_flush_log_at_trx_commit`控制，取值有如下三种：
    - =0 当提交事务时，并不将事务的重做日志写入磁盘上的日志文件，而是等待主线程每秒的刷新
    - =1 在执行commit时将重做日志缓冲同步写到磁盘，即伴有fsync的调用。
    - =2 将重做日志异步写到磁盘，即写到文件系统的缓存中。因此不能完全保证在执行commit时肯定会写入重做日志文件，只是有这个动作发生。
    
为了保证事务的ACID中的持久性，必须将innodb_flush_log_at_trx_commit设置为1

[^1]: UNIX域套接字,是一种通信方式。和通常说的套接字类似。传统的套接字是基于tcp/ip协议，主要用于不同的两台主机之间通信。而Unix域套接字主要用于同一台机器上的两个不同进程间通信。
